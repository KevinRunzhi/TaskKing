<!--pages/index/index.wxml-->
<view class="container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="header">
    <view class="title">æ—¶é—´ç½—ç›˜</view>
    <view class="subtitle">{{tasks.length}} ä¸ªä»»åŠ¡</view>
  </view>

  <!-- æ’åºæ  -->
  <scroll-view class="category-bar" scroll-x="true" enable-flex="true">
    <view wx:for="{{categoryTabs}}"
          wx:key="id"
          class="category-chip {{selectedCategoryId === item.id ? 'active' : ''}}"
          style="border-color: {{selectedCategoryId === item.id ? item.color : 'transparent'}}; background-color: {{selectedCategoryId === item.id ? item.color + '1A' : '#F1F5F9'}};"
          bindtap="onCategorySelect"
          data-id="{{item.id}}">
      <view class="category-chip-icon"
            style="background-color: {{item.color}};">
        {{item.icon}}
      </view>
      <text class="category-chip-name">{{item.name}}</text>
    </view>
    <view class="category-chip manage" bindtap="onManageCategories">
      <view class="category-chip-icon manage-icon">âš™ï¸</view>
      <text class="category-chip-name">ç®¡ç†</text>
    </view>
  </scroll-view>

  <view class="sort-bar">
    <picker bindchange="onSortChange" value="{{sortIndex}}" range="{{sortOptions}}">
      <view class="sort-picker">
        <text>{{sortOptions[sortIndex]}}</text>
        <text class="arrow">â–¼</text>
      </view>
    </picker>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-container">
    <input class="search-input"
           placeholder="æœç´¢ä»»åŠ¡..."
           value="{{searchKeyword}}"
           bindinput="onSearchInput"
           confirm-type="search" />
  </view>

  <!-- ä»»åŠ¡åˆ†ç±»åˆ—è¡¨ -->
  <view class="task-categories">
    <!-- æœªå®Œæˆä»»åŠ¡ -->
    <view class="category-section">
      <view class="category-header">
        <view class="category-title">æœªå®Œæˆä»»åŠ¡</view>
        <view class="category-count">{{pendingTasks.length}} ä¸ª</view>
      </view>

      <view wx:if="{{pendingTasks.length === 0}}" class="empty-category">
        <view class="empty-text">æš‚æ— æœªå®Œæˆä»»åŠ¡</view>
      </view>

      <view wx:else class="task-list">
        <view wx:for="{{pendingTasks}}"
              wx:key="id"
              class="task-item"
              bindtap="onTaskTap"
              data-id="{{item.id}}">

          <!-- ä»»åŠ¡ä¸»è¦å†…å®¹ -->
          <view class="task-content">
            <view class="task-header">
              <view class="custom-checkbox {{item.completed ? 'checked' : ''}}"
                    catchtap="onToggleComplete"
                    data-id="{{item.id}}">
                <view class="checkbox-icon">{{item.completed ? 'âœ“' : ''}}</view>
              </view>
              <view class="task-title">
                {{item.title}}
              </view>
              <view class="priority-badge priority-{{item.priority}}">
                {{priorityLabels[item.priority]}}
              </view>
            </view>

            <view wx:if="{{item.description}}" class="task-description">
              {{item.description}}
            </view>

            <view class="task-meta">
              <view wx:if="{{selectedCategoryId === 'all'}}"
                    class="task-category-tag"
                    style="border-color: {{item.categoryColor}}; background-color: {{item.categoryColorLight}}; color: {{item.categoryColor}};">
                {{item.categoryIcon}} {{item.categoryName}}
              </view>
              <view wx:if="{{item.displayDueDate}}" class="due-date {{isOverdueTask(item) ? 'overdue' : ''}}">
                ğŸ“… {{item.displayDueDate}}
              </view>
              <view wx:if="{{item.displayDueTime}}" class="due-time">
                â° {{item.displayDueTime}}
              </view>
              <view wx:if="{{item.recurrenceEnabled}}" class="recurrence-tag">
                ğŸ” {{item.recurrenceLabel}}
              </view>
              <view class="created-date">
                åˆ›å»ºäº {{formatCreatedDate(item.createdAt)}}
              </view>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="task-actions">
            <view class="action-btn edit-btn"
                  bindtap="onEditTask"
                  data-id="{{item.id}}">
              âœï¸
            </view>
            <view class="action-btn delete-btn"
                  bindtap="onDeleteTask"
                  data-id="{{item.id}}">
              ğŸ—‘ï¸
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å·²å®Œæˆä»»åŠ¡ -->
    <view class="category-section">
      <view class="category-header">
        <view class="category-title">å·²å®Œæˆä»»åŠ¡</view>
        <view class="category-count">{{completedTasks.length}} ä¸ª</view>
      </view>

      <view wx:if="{{completedTasks.length === 0}}" class="empty-category">
        <view class="empty-text">æš‚æ— å·²å®Œæˆä»»åŠ¡</view>
      </view>

      <view wx:else class="task-list">
        <view wx:for="{{completedTasks}}"
              wx:key="id"
              class="task-item completed"
              bindtap="onTaskTap"
              data-id="{{item.id}}">

          <!-- ä»»åŠ¡ä¸»è¦å†…å®¹ -->
          <view class="task-content">
            <view class="task-header">
              <view class="custom-checkbox {{item.completed ? 'checked' : ''}}"
                    catchtap="onToggleComplete"
                    data-id="{{item.id}}">
                <view class="checkbox-icon">{{item.completed ? 'âœ“' : ''}}</view>
              </view>
              <view class="task-title completed-text">
                {{item.title}}
              </view>
              <view class="priority-badge priority-{{item.priority}}">
                {{priorityLabels[item.priority]}}
              </view>
            </view>

            <view wx:if="{{item.description}}" class="task-description">
              {{item.description}}
            </view>

            <view class="task-meta">
              <view wx:if="{{selectedCategoryId === 'all'}}"
                    class="task-category-tag"
                    style="border-color: {{item.categoryColor}}; background-color: {{item.categoryColorLight}}; color: {{item.categoryColor}};">
                {{item.categoryIcon}} {{item.categoryName}}
              </view>
              <view wx:if="{{item.displayDueDate}}" class="due-date">
                ğŸ“… {{item.displayDueDate}}
              </view>
              <view wx:if="{{item.displayDueTime}}" class="due-time">
                â° {{item.displayDueTime}}
              </view>
              <view wx:if="{{item.recurrenceEnabled}}" class="recurrence-tag">
                ğŸ” {{item.recurrenceLabel}}
              </view>
              <view class="created-date">
                åˆ›å»ºäº {{formatCreatedDate(item.createdAt)}}
              </view>
            </view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="task-actions">
            <view class="action-btn edit-btn"
                  bindtap="onEditTask"
                  data-id="{{item.id}}">
              âœï¸
            </view>
            <view class="action-btn delete-btn"
                  bindtap="onDeleteTask"
                  data-id="{{item.id}}">
              ğŸ—‘ï¸
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- å…¨éƒ¨ä¸ºç©ºæ—¶çš„çŠ¶æ€ -->
    <view wx:if="{{tasks.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ“</view>
      <view class="empty-text">è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œç‚¹å‡»å³ä¸‹è§’æ·»åŠ ç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼</view>
    </view>
  </view>

  <!-- æ·»åŠ æŒ‰é’® -->
  <view class="fab" bindtap="onAddTask">
    <text class="fab-icon">+</text>
  </view>
</view>
