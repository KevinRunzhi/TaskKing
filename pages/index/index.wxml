<!--pages/index/index.wxml-->
<view class="container">
  <!-- 头部区域 -->
  <view class="header">
    <view class="title">时间罗盘</view>
    <view class="subtitle">{{tasks.length}} 个任务</view>
  </view>

  <!-- 排序栏 -->
  <scroll-view class="category-bar" scroll-x="true" enable-flex="true">
    <view wx:for="{{categoryTabs}}"
          wx:key="id"
          class="category-chip {{selectedCategoryId === item.id ? 'active' : ''}}"
          style="border-color: {{selectedCategoryId === item.id ? item.color : 'transparent'}}; background-color: {{selectedCategoryId === item.id ? item.color + '1A' : '#F1F5F9'}};"
          bindtap="onCategorySelect"
          data-id="{{item.id}}">
      <view class="category-chip-icon"
            style="background-color: {{item.color}};">
        {{item.icon}}
      </view>
      <text class="category-chip-name">{{item.name}}</text>
    </view>
    <view class="category-chip manage" bindtap="onManageCategories">
      <view class="category-chip-icon manage-icon">⚙️</view>
      <text class="category-chip-name">管理</text>
    </view>
  </scroll-view>

  <view class="sort-bar">
    <picker bindchange="onSortChange" value="{{sortIndex}}" range="{{sortOptions}}">
      <view class="sort-picker">
        <text>{{sortOptions[sortIndex]}}</text>
        <text class="arrow">▼</text>
      </view>
    </picker>
  </view>

  <!-- 搜索框 -->
  <view class="search-container">
    <input class="search-input"
           placeholder="搜索任务..."
           value="{{searchKeyword}}"
           bindinput="onSearchInput"
           confirm-type="search" />
  </view>

  <!-- 任务分类列表 -->
  <view class="task-categories">
    <!-- 未完成任务 -->
    <view class="category-section">
      <view class="category-header">
        <view class="category-title">未完成任务</view>
        <view class="category-count">{{pendingTasks.length}} 个</view>
      </view>

      <view wx:if="{{pendingTasks.length === 0}}" class="empty-category">
        <view class="empty-text">暂无未完成任务</view>
      </view>

      <view wx:else class="task-list">
        <view wx:for="{{pendingTasks}}"
              wx:key="id"
              class="task-item"
              bindtap="onTaskTap"
              data-id="{{item.id}}">

          <!-- 任务主要内容 -->
          <view class="task-content">
            <view class="task-header">
              <view class="custom-checkbox {{item.completed ? 'checked' : ''}}"
                    catchtap="onToggleComplete"
                    data-id="{{item.id}}">
                <view class="checkbox-icon">{{item.completed ? '✓' : ''}}</view>
              </view>
              <view class="task-title">
                {{item.title}}
              </view>
              <view class="priority-badge priority-{{item.priority}}">
                {{priorityLabels[item.priority]}}
              </view>
            </view>

            <view wx:if="{{item.description}}" class="task-description">
              {{item.description}}
            </view>

            <view class="task-meta">
              <view wx:if="{{selectedCategoryId === 'all'}}"
                    class="task-category-tag"
                    style="border-color: {{item.categoryColor}}; background-color: {{item.categoryColorLight}}; color: {{item.categoryColor}};">
                {{item.categoryIcon}} {{item.categoryName}}
              </view>
              <view wx:if="{{item.displayDueDate}}" class="due-date {{isOverdueTask(item) ? 'overdue' : ''}}">
                📅 {{item.displayDueDate}}
              </view>
              <view wx:if="{{item.displayDueTime}}" class="due-time">
                ⏰ {{item.displayDueTime}}
              </view>
              <view wx:if="{{item.recurrenceEnabled}}" class="recurrence-tag">
                🔁 {{item.recurrenceLabel}}
              </view>
              <view class="created-date">
                创建于 {{formatCreatedDate(item.createdAt)}}
              </view>
            </view>
          </view>

          <!-- 操作按钮 -->
          <view class="task-actions">
            <view class="action-btn edit-btn"
                  bindtap="onEditTask"
                  data-id="{{item.id}}">
              ✏️
            </view>
            <view class="action-btn delete-btn"
                  bindtap="onDeleteTask"
                  data-id="{{item.id}}">
              🗑️
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 已完成任务 -->
    <view class="category-section">
      <view class="category-header">
        <view class="category-title">已完成任务</view>
        <view class="category-count">{{completedTasks.length}} 个</view>
      </view>

      <view wx:if="{{completedTasks.length === 0}}" class="empty-category">
        <view class="empty-text">暂无已完成任务</view>
      </view>

      <view wx:else class="task-list">
        <view wx:for="{{completedTasks}}"
              wx:key="id"
              class="task-item completed"
              bindtap="onTaskTap"
              data-id="{{item.id}}">

          <!-- 任务主要内容 -->
          <view class="task-content">
            <view class="task-header">
              <view class="custom-checkbox {{item.completed ? 'checked' : ''}}"
                    catchtap="onToggleComplete"
                    data-id="{{item.id}}">
                <view class="checkbox-icon">{{item.completed ? '✓' : ''}}</view>
              </view>
              <view class="task-title completed-text">
                {{item.title}}
              </view>
              <view class="priority-badge priority-{{item.priority}}">
                {{priorityLabels[item.priority]}}
              </view>
            </view>

            <view wx:if="{{item.description}}" class="task-description">
              {{item.description}}
            </view>

            <view class="task-meta">
              <view wx:if="{{selectedCategoryId === 'all'}}"
                    class="task-category-tag"
                    style="border-color: {{item.categoryColor}}; background-color: {{item.categoryColorLight}}; color: {{item.categoryColor}};">
                {{item.categoryIcon}} {{item.categoryName}}
              </view>
              <view wx:if="{{item.displayDueDate}}" class="due-date">
                📅 {{item.displayDueDate}}
              </view>
              <view wx:if="{{item.displayDueTime}}" class="due-time">
                ⏰ {{item.displayDueTime}}
              </view>
              <view wx:if="{{item.recurrenceEnabled}}" class="recurrence-tag">
                🔁 {{item.recurrenceLabel}}
              </view>
              <view class="created-date">
                创建于 {{formatCreatedDate(item.createdAt)}}
              </view>
            </view>
          </view>

          <!-- 操作按钮 -->
          <view class="task-actions">
            <view class="action-btn edit-btn"
                  bindtap="onEditTask"
                  data-id="{{item.id}}">
              ✏️
            </view>
            <view class="action-btn delete-btn"
                  bindtap="onDeleteTask"
                  data-id="{{item.id}}">
              🗑️
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 全部为空时的状态 -->
    <view wx:if="{{tasks.length === 0}}" class="empty-state">
      <view class="empty-icon">📝</view>
      <view class="empty-text">还没有任务，点击右下角添加第一个任务吧！</view>
    </view>
  </view>

  <!-- 添加按钮 -->
  <view class="fab" bindtap="onAddTask">
    <text class="fab-icon">+</text>
  </view>
</view>
