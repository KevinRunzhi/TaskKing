<block wx:if="{{viewMode === 'stacked'}}">
  <view class="page">
    <view class="header-card">
      <view class="header-title">æ—¶é—´ç½—ç›˜</view>
      <view class="header-subtitle">
        å½“å‰ {{activeTasks.length}} ä¸ªæ´»è·ƒä»»åŠ¡ Â· é˜ˆå€¼ {{threshold}}
      </view>
    </view>

    <view class="filter-card">
      <view class="filter-row">
        <view class="search-box">
          <text class="search-icon">ğŸ”</text>
          <input
            class="search-input"
            placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜æˆ–æè¿°"
            value="{{searchKeyword}}"
            confirm-type="search"
            bindinput="onSearchInput"
          />
          <view
            wx:if="{{searchKeyword}}"
            class="search-clear"
            bindtap="onClearSearch"
          >
            âœ•
          </view>
        </view>

        <view class="mode-buttons">
          <view
            class="mode-toggle primary"
            bindtap="switchToExpanded"
          >
            è¿›å…¥æ‹–æ‹½æ¨¡å¼
          </view>
        </view>
      </view>

      <view class="filter-row secondary">
        <picker
          mode="selector"
          range="{{categoryOptions}}"
          range-key="name"
          value="{{selectedCategoryIndex}}"
          bindchange="onCategoryChange"
        >
          <view class="picker-display">
            <text>
              {{(categoryOptions[selectedCategoryIndex] && categoryOptions[selectedCategoryIndex].name) || 'å…¨éƒ¨åˆ†ç±»'}}
            </text>
            <text class="picker-arrow">âŒ„</text>
          </view>
        </picker>
      </view>

      <scroll-view
        wx:if="{{tagOptions.length}}"
        scroll-x="true"
        class="tag-scroll"
      >
        <view
          wx:for="{{tagOptions}}"
          wx:key="*this"
          class="tag-chip {{selectedTags.indexOf(item) !== -1 ? 'active' : ''}}"
          data-tag="{{item}}"
          bindtap="onTagTap"
        >
          #{{item}}
        </view>
      </scroll-view>
    </view>

    <view class="stats-card">
      <view class="stat-item q1">
        <view class="stat-label">ç«‹å³å¤„ç†</view>
        <view class="stat-value">{{quadrantStats.q1}}</view>
      </view>
      <view class="stat-item q2">
        <view class="stat-label">è®¡åˆ’å®‰æ’</view>
        <view class="stat-value">{{quadrantStats.q2}}</view>
      </view>
      <view class="stat-item q3">
        <view class="stat-label">å°½é‡å§”æ‰˜</view>
        <view class="stat-value">{{quadrantStats.q3}}</view>
      </view>
      <view class="stat-item q4">
        <view class="stat-label">å¯ä»¥èˆå¼ƒ</view>
        <view class="stat-value">{{quadrantStats.q4}}</view>
      </view>
    </view>

    <view class="stacked-board">
      <view
        wx:for="{{stackedConfig}}"
        wx:key="key"
        class="stacked-quadrant {{item.key}}"
      >
        <view class="stacked-header">
          <view class="stacked-title">{{item.title}}</view>
          <view class="stacked-count">{{quadrantBuckets[item.key].length}}</view>
        </view>
        <view
          wx:if="{{!quadrantBuckets[item.key].length}}"
          class="stacked-empty"
        >
          æš‚æ— ä»»åŠ¡
        </view>
        <view wx:else class="stacked-list">
          <view
            wx:for="{{quadrantBuckets[item.key]}}"
            wx:for-item="task"
            wx:key="id"
            class="stacked-card"
            data-id="{{task.id}}"
            bindtap="onCardTap"
          >
            <view class="stacked-card-title">{{task.title}}</view>
            <view class="stacked-card-meta">
              é‡è¦ {{task.importance}} Â· ç´§æ€¥ {{task.urgency}}
            </view>
            <view wx:if="{{task.dueText}}" class="stacked-card-due">
              â° {{task.dueText}}
            </view>
            <view class="stacked-card-actions">
              <view
                class="stacked-card-action"
                data-id="{{task.id}}"
                catchtap="onCompleteTap"
              >
                å®Œæˆ
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="completed-section">
      <view class="section-header">
        <view class="section-title">å·²å®Œæˆä»»åŠ¡</view>
        <view class="section-count">{{completedTasks.length}}</view>
      </view>
      <view wx:if="{{completedTasks.length === 0}}" class="empty-completed">
        æš‚æ— å·²å®Œæˆä»»åŠ¡ï¼Œç»§ç»­ä¿æŒèŠ‚å¥ï½
      </view>
      <view wx:else class="completed-list">
        <view
          wx:for="{{completedTasks}}"
          wx:key="id"
          class="completed-item"
          data-id="{{item.id}}"
          bindtap="onShowCompletedDetail"
        >
          <view class="completed-title">{{item.title}}</view>
          <view class="completed-meta">
            {{item.categoryIcon}} {{item.categoryName}}
            <text wx:if="{{item.completedAtLabel}}">
              Â· å®Œæˆäº {{item.completedAtLabel}}
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>
</block>

<block wx:elif="{{viewMode === 'expanded'}}">
  <view class="drag-overlay">
    <view class="overlay-header">
      <view class="overlay-title">æ‹–æ‹½æ¨¡å¼</view>
      <view class="overlay-actions">
        <view class="overlay-hint">
          {{batchMode ? 'æ‰¹é‡æ¨¡å¼ï¼šç‚¹å‡»å¡ç‰‡å¯å‹¾é€‰' : 'æ‹–åŠ¨ä»»åŠ¡å¡ç‰‡ï¼Œå³æ—¶æ›´æ–°é‡è¦/ç´§æ€¥'}}
        </view>
        <view
          class="overlay-btn {{batchMode ? 'primary' : ''}}"
          bindtap="toggleBatchMode"
        >
          {{batchMode ? 'é€€å‡ºæ‰¹é‡' : 'æ‰¹é‡æ“ä½œ'}}
        </view>
        <view class="overlay-btn close" bindtap="switchToStacked">
          è¿”å›
        </view>
      </view>
    </view>

    <view class="overlay-content">
      <view class="quadrant-wrapper">
        <movable-area
          id="quadrantArea"
          class="quadrant-area"
          damping="40"
          friction="16"
        >
          <movable-view
            wx:for="{{activeTasks}}"
            wx:key="id"
            class="task-card"
            direction="{{batchMode ? 'none' : 'all'}}"
            x="{{item.position.x}}"
            y="{{item.position.y}}"
            data-id="{{item.id}}"
            bindchange="onCardChange"
            bindtouchend="onCardTouchEnd"
            inertia="true"
          >
            <view
              class="card-surface quadrant-{{item.quadrant}} {{item.selected ? 'selected' : ''}}"
              data-id="{{item.id}}"
              bindtap="onCardTap"
            >
              <view class="card-content">
                <view class="card-title">{{item.title}}</view>
                <view class="card-due {{item.isOverdue ? 'danger' : ''}}">
                  {{item.dueText || 'æœªè®¾ç½®æˆªæ­¢'}}
                </view>
              </view>
              <view wx:if="{{batchMode}}" class="batch-overlay">
                <view
                  class="batch-checkbox {{item.selected ? 'checked' : ''}}"
                  data-id="{{item.id}}"
                  catchtap="onToggleSelect"
                >
                  <text>{{item.selected ? 'âœ“' : ''}}</text>
                </view>
              </view>
            </view>
          </movable-view>
        </movable-area>

        <view class="axis-label axis-left">ä¸é‡è¦</view>
        <view class="axis-label axis-right">é‡è¦</view>
        <view class="axis-label axis-top">ç´§æ€¥</view>
        <view class="axis-label axis-bottom">ä¸ç´§æ€¥</view>

        <view class="quadrant-title title-1">ç«‹å³å¤„ç†</view>
        <view class="quadrant-title title-2">è®¡åˆ’å®‰æ’</view>
        <view class="quadrant-title title-3">å°½é‡å§”æ‰˜</view>
        <view class="quadrant-title title-4">å¯ä»¥èˆå¼ƒ</view>
      </view>
    </view>
  </view>
</block>
