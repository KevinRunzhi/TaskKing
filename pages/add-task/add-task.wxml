<!--pages/add-task/add-task.wxml-->
<!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
<view class="custom-nav-bar" style="padding-top: {{statusBarHeight}}px;">
  <view class="nav-content">
    <view class="nav-back" bindtap="onCancel">
      <text class="nav-back-icon">â€¹</text>
    </view>
    <view class="nav-title">æ·»åŠ ä»»åŠ¡</view>
    <view class="nav-placeholder"></view>
  </view>
</view>

<view class="container" style="margin-top: {{navBarHeight}}px;">
  <form bindsubmit="onSubmit">
    <!-- ä»»åŠ¡æ ‡é¢˜ -->
    <view class="form-group">
      <view class="label">ä»»åŠ¡æ ‡é¢˜ *</view>
      <input
        class="input"
        name="title"
        placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜"
        value="{{formData.title}}"
        bindinput="onTitleInput"
        maxlength="100"
        focus="{{true}}"
      />
      <view class="char-count">{{formData.title.length}}/100</view>
    </view>

    <!-- ä»»åŠ¡æè¿° -->
    <view class="form-group">
      <view class="label">ä»»åŠ¡æè¿°</view>
      <textarea
        class="textarea"
        name="description"
        placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰"
        value="{{formData.description}}"
        bindinput="onDescriptionInput"
        maxlength="500"
        auto-height
      ></textarea>
      <view class="char-count">{{formData.description.length}}/500</view>
    </view>

    <!-- ä»»åŠ¡åˆ†ç±» -->
    <view class="form-group">
      <view class="label-row">
        <view class="label">ä»»åŠ¡åˆ†ç±»</view>
        <navigator url="/pages/categories/categories" class="manage-link">ç®¡ç†åˆ†ç±»</navigator>
      </view>
      <picker
        mode="selector"
        range="{{categories}}"
        range-key="name"
        value="{{selectedCategoryIndex}}"
        bindchange="onCategoryChange"
      >
        <view class="category-picker">
          <view
            class="category-icon"
            style="background-color: {{selectedCategory ? selectedCategory.color : '#cccccc'}}"
          >
            {{selectedCategory ? selectedCategory.icon : 'ğŸ“Œ'}}
          </view>
          <view class="category-name">
            {{selectedCategory ? selectedCategory.name : 'æœªåˆ†ç±»'}}
          </view>
        </view>
      </picker>
    </view>

    <!-- æˆªæ­¢æ—¥æœŸ -->
    <view class="form-group">
      <view class="label">æˆªæ­¢æ—¥æœŸ</view>
      <picker mode="date" value="{{formData.dueDate}}" start="{{today}}" bindchange="onDueDateChange">
        <view class="date-picker {{formData.dueDate ? '' : 'placeholder'}}">
          {{formData.dueDate ? dueDateDisplay : 'é€‰æ‹©æˆªæ­¢æ—¥æœŸï¼ˆå¯é€‰ï¼‰'}}
        </view>
      </picker>
      <view wx:if="{{formData.dueDate}}" class="clear-date" bindtap="clearDate">
        æ¸…é™¤æ—¥æœŸ
      </view>
    </view>

    <!-- æˆªæ­¢æ—¶é—´ -->
    <view class="form-group">
      <view class="label">æˆªæ­¢æ—¶é—´</view>
      <picker
        mode="time"
        value="{{formData.dueTime || defaultReminderTime}}"
        start="00:00"
        end="23:59"
        bindchange="onDueTimeChange"
      >
        <view class="date-picker {{formData.dueTime ? '' : 'placeholder'}}">
          {{formData.dueTime ? formData.dueTime : 'é€‰æ‹©æˆªæ­¢æ—¶é—´ï¼ˆå¯é€‰ï¼‰'}}
        </view>
      </picker>
    </view>

    <!-- æé†’è®¾ç½® -->
    <view class="form-group reminder-toggle">
      <view class="label">ä»»åŠ¡æé†’</view>
      <switch class="reminder-switch" checked="{{formData.reminderEnabled}}" bindchange="onReminderToggle" />
    </view>

    <view wx:if="{{formData.reminderEnabled}}">
      <view class="form-group">
        <view class="label">æé†’æ—¥æœŸ</view>
        <picker
          mode="date"
          value="{{formData.reminderDate}}"
          start="{{today}}"
          bindchange="onReminderDateChange"
        >
          <view class="date-picker {{formData.reminderDate ? '' : 'placeholder'}}">
            {{formData.reminderDate ? reminderDateDisplay : 'é€‰æ‹©æé†’æ—¥æœŸ'}}
          </view>
        </picker>
      </view>

      <view class="form-group">
        <view class="label">æé†’æ—¶é—´</view>
        <picker
          mode="time"
          value="{{formData.reminderTime || defaultReminderTime}}"
          start="00:00"
          end="23:59"
          bindchange="onReminderTimeChange"
        >
          <view class="date-picker {{formData.reminderTime ? '' : 'placeholder'}}">
            {{formData.reminderTime ? formData.reminderTime : 'é€‰æ‹©æé†’æ—¶é—´'}}
          </view>
        </picker>
        <view class="clear-date" bindtap="clearReminder">å…³é—­æé†’</view>
      </view>
    </view>

    <!-- é‡å¤è®¾ç½® -->
    <view class="form-group recurrence-toggle">
      <view class="label">é‡å¤ä»»åŠ¡</view>
      <switch class="recurrence-switch" checked="{{formData.recurrenceEnabled}}" bindchange="onRecurrenceToggle" />
    </view>

    <view wx:if="{{formData.recurrenceEnabled}}">
      <view class="form-group">
        <view class="label">é‡å¤é¢‘ç‡</view>
        <picker
          mode="selector"
          range="{{recurrenceOptions}}"
          range-key="label"
          value="{{recurrenceTypeIndex}}"
          bindchange="onRecurrenceTypeChange"
        >
          <view class="date-picker">
            {{recurrenceOptions[recurrenceTypeIndex] ? recurrenceOptions[recurrenceTypeIndex].label : ''}}
          </view>
        </picker>
      </view>

      <view class="form-group">
        <view class="label">é‡å¤é—´éš”</view>
        <view class="interval-input-wrapper">
          <input
            class="interval-input"
            type="number"
            placeholder="è¯·è¾“å…¥é‡å¤é—´éš”"
            min="1"
            value="{{formData.recurrenceInterval}}"
            bindinput="onRecurrenceIntervalInput"
          />
          <view class="interval-unit">æ¯{{formData.recurrenceInterval || 1}}{{recurrenceIntervalUnit}}</view>
        </view>
      </view>

      <view class="form-group">
        <view class="label">é‡å¤ç»“æŸæ—¶é—´</view>
        <picker
          mode="date"
          value="{{formData.recurrenceEndDate}}"
          start="{{formData.dueDate || today}}"
          bindchange="onRecurrenceEndDateChange"
        >
          <view class="date-picker {{formData.recurrenceEndDate ? '' : 'placeholder'}}">
            {{formData.recurrenceEndDate ? recurrenceEndDateDisplay : 'é€‰æ‹©ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰'}}
          </view>
        </picker>
        <view wx:if="{{formData.recurrenceEndDate}}" class="clear-date" bindtap="clearRecurrenceEndDate">
          æ¸…é™¤ç»“æŸæ—¥æœŸ
        </view>
      </view>

      <view wx:if="{{showRecurrenceWeekdays}}" class="form-group">
        <view class="label">è‡ªå®šä¹‰æ˜ŸæœŸ</view>
        <view class="weekday-selector">
          <view
            wx:for="{{weekdayOptions}}"
            wx:key="value"
            class="weekday-option {{formData.recurrenceWeekdays.indexOf(item.value) !== -1 ? 'selected' : ''}}"
            data-value="{{item.value}}"
            bindtap="onRecurrenceWeekdayToggle"
          >
            {{item.label}}
          </view>
        </view>
      </view>
    </view>

    <!-- ä¼˜å…ˆçº§é€‰æ‹© -->
    <view class="form-group">
      <view class="label">ä¼˜å…ˆçº§</view>
      <view class="priority-options">
        <view
          wx:for="{{priorityOptions}}"
          wx:key="value"
          class="priority-option {{formData.priority === item.value ? 'selected' : ''}}"
          bindtap="onPrioritySelect"
          data-priority="{{item.value}}"
        >
          <view class="priority-color priority-{{item.value}}"></view>
          <view class="priority-text">{{item.label}}</view>
        </view>
      </view>
    </view>

    <!-- é”™è¯¯æç¤º -->
    <view wx:if="{{errors.length > 0}}" class="error-container">
      <view wx:for="{{errors}}" wx:key="*this" class="error-item">
        {{item}}
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="button-group">
      <button class="btn-secondary" bindtap="onCancel">å–æ¶ˆ</button>
      <button class="btn-primary" form-type="submit" disabled="{{!isValid}}">
        åˆ›å»ºä»»åŠ¡
      </button>
    </view>
  </form>
</view>
